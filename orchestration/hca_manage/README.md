# Hca Manage
Python CLI tools to help work with TDR and HCA.

## How to run
- Install [Poetry](https://python-poetry.org/) (make sure you're using python 3)
- Run `poetry install` from the orchestration directory to install dependencies
- Test it with `poetry run check -V` to get the version

Before running it, you need to make sure your google application default credentials are all lined up.

Do so by running `gcloud auth application-default login` and logging in with the appropriate account.

## Tools

### Check
Checks the integrity of an HCA dataset or snapshot, looking for null file references, duplicate rows and dangling
links -> project references.

Example run:
`poetry run check -e dev -i 8cb49ef6-63db-4f56-b9a8-d33278d93z0f`

To actually remove things, add the remove `-r` flag after:
`poetry run check -e dev -i 8cb49ef6-63db-4f56-b9a8-d33278d93z0f -r`

Be very sure and careful when adding the remove flag.

_Notes_: 
- You may need to first add your user to the dataset as a steward - 
being in monster@firecloud may not propagate your permissions.
- If you run with -r you may get an error from TDR about your bucket permissions -
follow the error message and add the indicated accounts to the bucket (likely your user, the ingest account, 
and your proxy group). **Be sure to remove these users from the bucket and the dataset after you are done.**

### Snapshot

Tooling to create, modify policies and search for HCA snapshots. Note, snapshot creation has been largely supplanted by our 
[cut_snapshot pipeline.](https://github.com/DataBiosphere/hca-ingest/blob/0b9c40a3996d02bd69ce17690d132d4b67cca442/orchestration/dagster_orchestration/hca_orchestration/pipelines/cut_snapshot.py)

Example of snapshot creation:
`poetry run snapshot -e dev -c -d hca_dev_20201203 -q mytest1`

Example of snapshot policy updates (useful to grant read access for other users):
`poetry run snapshot -e dev add_policy_member -n reader -i <some_uuid>> -p user@example.com`

Example of querying snapshots (useful to search for a snapshot by name):
`poetry run snapshot -e dev query -n hca`

### Dataset 

Tooling to create, modify policies and search for HCA datasets. 

Example of dataset creation:
`poetry run dataset -e dev create -n mydataset -b 12345-abc -p user@example.com`
Note that the schema can be provided via the optional `-s` argument; if not present, the tool assumes a schema is present 
at `{repo_root}/schema/target/schema.json` (which should be generated by compiling the scala source code via `sbt`)

Example of querying datasets (useful to search for a dataset by name):
`poetry run dataset -e dev query -n hca`

Example of dataset removal:
`poetry run dataset -e dev -r -n myfakedataset`

### Soft-deletion
Tooling that submits soft-delete jobs to TDR.

Example of soft deletion:
`poetry run soft_delete -e dev -p path/to/csv -t myfaketable -j myfakeproject -d myfakedataset`
